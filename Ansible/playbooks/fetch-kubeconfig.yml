---
- name: Fetch kubeconfig from Kubernetes master node
  hosts: k8s_master
  become: false
  gather_facts: no

  tasks:
    - name: Check if admin.conf exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf

    - name: Check if user kubeconfig exists
      stat:
        path: "{{ ansible_env.HOME }}/.kube/config"
      register: user_kubeconfig

    - name: Display kubeconfig location
      debug:
        msg: "Kubeconfig found at: {{ admin_conf.stat.path if admin_conf.stat.exists else 'NOT FOUND' }}"

    - name: Fetch admin.conf from master node
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: "{{ playbook_dir }}/../kubeconfig/admin.conf"
        flat: yes
      when: admin_conf.stat.exists

    - name: Fetch user kubeconfig from master node
      fetch:
        src: "{{ ansible_env.HOME }}/.kube/config"
        dest: "{{ playbook_dir }}/../kubeconfig/user-kubeconfig.conf"
        flat: yes
      when: user_kubeconfig.stat.exists

    - name: Display instructions
      debug:
        msg:
          - "Kubeconfig files have been fetched to ansible/kubeconfig/"
          - "To use in Jenkins:"
          - "1. Copy the file to Jenkins agent"
          - "2. Add as 'Secret file' credential with ID 'kubeconfig'"
          - "Or use the content directly in Jenkins pipeline"
